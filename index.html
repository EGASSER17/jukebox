<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mon Jukebox</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #1a0a00; color: #f0e0c0; font-family: 'Georgia', serif; min-height: 100vh; }
  .machine { max-width: 480px; margin: 0 auto; background: linear-gradient(180deg,#8B1A00 0%,#5C1100 40%,#3a0a00 100%); min-height: 100vh; border-left: 6px solid #c8860a; border-right: 6px solid #c8860a; box-shadow: 0 0 40px #c8860a55; display: flex; flex-direction: column; }
  .header { background: linear-gradient(90deg,#c8860a,#f5c842,#c8860a); padding: 14px; text-align: center; border-bottom: 4px solid #8B1A00; }
  .header h1 { font-size: 1.6rem; color: #1a0a00; letter-spacing: 3px; text-transform: uppercase; }
  .header p { font-size: .6rem; color: #3a0a00; letter-spacing: 2px; margin-top: 2px; }
  .screen { background: #0a1a0a; margin: 12px 16px; border-radius: 8px; border: 3px solid #c8860a; padding: 12px; box-shadow: inset 0 0 20px #00000088; }
  .np-label { font-size: .6rem; color: #c8860a; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 4px; }
  .np-title { font-size: 1rem; color: #7fff7f; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .np-artist { font-size: .8rem; color: #aaffaa; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .progress-bar { background: #1a3a1a; border-radius: 4px; height: 5px; margin-top: 8px; overflow: hidden; }
  .progress-fill { background: #7fff7f; height: 100%; width: 0%; transition: width 1s linear; }
  #yt-player { display: none; }
  .controls { display: flex; justify-content: center; gap: 12px; margin: 6px 16px; }
  .ctrl-btn { background: #c8860a; border: none; border-radius: 50%; width: 42px; height: 42px; font-size: 1.1rem; cursor: pointer; color: #1a0a00; transition: background .15s; box-shadow: 0 3px 8px #00000066; }
  .ctrl-btn:hover { background: #f5c842; }
  .queue-section { margin: 0 16px 8px; }
  .section-label { font-size: .6rem; color: #c8860a; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 5px; }
  .queue-list { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 4px; }
  .queue-list::-webkit-scrollbar { height: 3px; }
  .queue-list::-webkit-scrollbar-thumb { background: #c8860a; border-radius: 2px; }
  .queue-item { flex-shrink: 0; background: #3a0a00; border-radius: 4px; padding: 4px 8px; font-size: .65rem; max-width: 130px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border: 1px solid #c8860a44; }
  .queue-item.active { border-color: #7fff7f; color: #7fff7f; }
  .loading-section { margin: 0 16px 8px; }
  .loading-bar { background: #3a0a00; border-radius: 4px; height: 6px; overflow: hidden; }
  .loading-fill { background: linear-gradient(90deg,#c8860a,#f5c842); height: 100%; width: 0%; transition: width .4s; }
  .loading-text { font-size: .6rem; color: #c8860a; margin-top: 3px; text-align: center; }
  .albums-section { flex: 1; margin: 0 16px; overflow: hidden; display: flex; flex-direction: column; min-height: 0; }
  .albums-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; overflow-y: auto; flex: 1; padding-bottom: 10px; }
  .albums-grid::-webkit-scrollbar { width: 4px; }
  .albums-grid::-webkit-scrollbar-thumb { background: #c8860a; border-radius: 2px; }
  .album-card { cursor: pointer; border-radius: 6px; overflow: hidden; border: 2px solid transparent; transition: border .15s, transform .15s; position: relative; }
  .album-card:hover { border-color: #f5c842; transform: scale(1.03); }
  .album-card.playing { border-color: #1DB954; }
  .album-card.loading-album { opacity: .5; }
  .album-card img { width: 100%; aspect-ratio: 1; display: block; object-fit: cover; background: #222; }
  .album-name { font-size: .58rem; text-align: center; padding: 2px 3px; background: #1a0a00; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .album-artist { font-size: .52rem; text-align: center; padding: 0 3px 2px; background: #1a0a00; color: #c8860a; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .track-count { position: absolute; top: 3px; left: 3px; background: #000000aa; border-radius: 3px; padding: 1px 4px; font-size: .55rem; color: #c8860a; }
  .panel { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: #1a0a00; border-top: 3px solid #c8860a; border-left: 6px solid #c8860a; border-right: 6px solid #c8860a; max-height: 65vh; overflow-y: auto; z-index: 100; display: none; padding-bottom: 12px; }
  .panel.open { display: block; }
  .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background: #3a0a00; position: sticky; top: 0; z-index: 1; }
  .panel-header-info { flex: 1; overflow: hidden; }
  .panel-title { font-size: .9rem; color: #f5c842; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .panel-sub { font-size: .65rem; color: #c8860a; margin-top: 1px; }
  .close-btn { background: none; border: none; color: #c8860a; font-size: 1.3rem; cursor: pointer; margin-left: 8px; }
  .track-item { display: flex; align-items: center; gap: 10px; padding: 10px 16px; border-bottom: 1px solid #3a0a0033; transition: background .1s; cursor: pointer; }
  .track-item:hover { background: #2a0800; }
  .track-item.in-queue { background: #0a2a00; }
  .track-num { font-size: .75rem; color: #c8860a; min-width: 24px; text-align: right; font-family: monospace; }
  .track-name { flex: 1; font-size: .82rem; }
  .track-dur { font-size: .68rem; color: #888; margin-left: 6px; }
  .add-indicator { font-size: .75rem; color: #7fff7f; opacity: 0; transition: opacity .3s; }
  .track-item.added .add-indicator { opacity: 1; }
  .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1DB954; color: white; padding: 9px 18px; border-radius: 20px; font-size: .82rem; opacity: 0; transition: opacity .3s; z-index: 300; pointer-events: none; }
  .toast.show { opacity: 1; }
</style>
</head>
<body>
<div id="yt-player"></div>
<div class="machine">
  <div class="header">
    <h1>üéµ Jukebox</h1>
    <p>Mix Soir√©e Early</p>
  </div>

  <div class="screen">
    <div class="np-label">‚ñ∂ En cours</div>
    <div class="np-title" id="npTitle">‚Äî</div>
    <div class="np-artist" id="npArtist">‚Äî</div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  </div>

  <div class="controls">
    <button class="ctrl-btn" onclick="skipQueue()">‚è≠</button>
    <button class="ctrl-btn" id="playBtn" onclick="togglePlay()">‚ñ∂</button>
    <button class="ctrl-btn" onclick="clearQueue()" title="Vider la queue">üóë</button>
    <button class="ctrl-btn" id="shuffleBtn" onclick="toggleShuffle()" title="Al√©atoire">üîÄ</button>
  </div>

  <div class="queue-section" id="queueSection" style="display:none">
    <div class="section-label">Queue (<span id="queueCount">0</span> titres)</div>
    <div class="queue-list" id="queueList"></div>
  </div>

  <div class="loading-section" id="loadingSection" style="display:none">
    <div class="loading-bar"><div class="loading-fill" id="loadingFill"></div></div>
    <div class="loading-text" id="loadingText">Chargement...</div>
  </div>

  <div class="albums-section">
    <div class="section-label">Albums (<span id="albumCount">0</span>)</div>
    <div class="albums-grid" id="albumsGrid">
      <div style="grid-column:1/-1;text-align:center;color:#c8860a;font-size:.8rem;padding:20px;">Chargement des albums... üéµ</div>
    </div>
  </div>
</div>

<!-- Track panel -->
<div class="panel" id="trackPanel">
  <div class="panel-header">
    <div class="panel-header-info">
      <div class="panel-title" id="panelTitle">Album</div>
      <div class="panel-sub" id="panelSub"></div>
    </div>
    <button class="close-btn" onclick="closePanel()">‚úï</button>
  </div>
  <div id="tracksList"></div>
</div>

<div class="toast" id="toast"></div>

<script>
const YT_KEY = 'AIzaSyAWXE17MurvNcrGZMKH1d-X6aY6IF3Z_lw';
const CACHE_KEY = 'jukebox_albums_v3';

const PLAYLIST = [
  {album:"The Beatles (White Album)", artist:"The Beatles"},
  {album:"Sgt. Pepper's Lonely Hearts Club Band", artist:"The Beatles"},
  {album:"Electric Warrior", artist:"T. Rex"},
  {album:"Grace", artist:"Jeff Buckley"},
  {album:"Ziggy Stardust", artist:"David Bowie"},
  {album:"Justified", artist:"Justin Timberlake"},
  {album:"Homework", artist:"Daft Punk"},
  {album:"Pablo Honey", artist:"Radiohead"},
  {album:"The Wild Hunt", artist:"The Tallest Man On Earth"},
  {album:"Breakfast in America", artist:"Supertramp"},
  {album:"Different Class", artist:"Pulp"},
  {album:"Wolfgang Amadeus Phoenix", artist:"Phoenix"},
  {album:"Pet Sounds", artist:"The Beach Boys"},
  {album:"Crosby, Stills & Nash", artist:"Crosby, Stills & Nash"},
  {album:"Business Casual", artist:"Chromeo"},
  {album:"Random Access Memories", artist:"Daft Punk"},
  {album:"Unplugged", artist:"Eric Clapton"},
  {album:"Pink Moon", artist:"Nick Drake"},
  {album:"The Freewheelin' Bob Dylan", artist:"Bob Dylan"},
  {album:"Led Zeppelin III", artist:"Led Zeppelin"},
  {album:"Led Zeppelin IV", artist:"Led Zeppelin"},
  {album:"Rumours", artist:"Fleetwood Mac"},
  {album:"Wish You Were Here", artist:"Pink Floyd"},
  {album:"Brothers In Arms", artist:"Dire Straits"},
  {album:"OK Computer", artist:"Radiohead"},
  {album:"x", artist:"Ed Sheeran"},
  {album:"21", artist:"Adele"},
  {album:"Otis Blue", artist:"Otis Redding"},
  {album:"Songs In The Key Of Life", artist:"Stevie Wonder"},
  {album:"Mud Slide Slim", artist:"James Taylor"},
  {album:"The Stranger", artist:"Billy Joel"},
  {album:"Tea For The Tillerman", artist:"Cat Stevens"},
  {album:"Let It Be", artist:"The Beatles"},
  {album:"Hunky Dory", artist:"David Bowie"},
  {album:"Legend", artist:"Bob Marley & The Wailers"},
  {album:"Play", artist:"Moby"},
  {album:"Imagine", artist:"John Lennon"},
  {album:"A Night At The Opera", artist:"Queen"},
  {album:"Goodbye Yellow Brick Road", artist:"Elton John"},
  {album:"The Marshall Mathers LP", artist:"Eminem"},
  {album:"My Beautiful Dark Twisted Fantasy", artist:"Kanye West"},
  {album:"Graceland", artist:"Paul Simon"},
  {album:"Reflektor", artist:"Arcade Fire"},
  {album:"A Rush of Blood to the Head", artist:"Coldplay"},
  {album:"Nevermind", artist:"Nirvana"},
  {album:"L.A. Woman", artist:"The Doors"},
  {album:"Justice", artist:"Justice"},
  {album:"Supernatural", artist:"Santana"},
  {album:"O", artist:"Damien Rice"},
  {album:"Just Enough Education To Perform", artist:"Stereophonics"},
  {album:"The Libertines", artist:"The Libertines"},
  {album:"Mellon Collie and the Infinite Sadness", artist:"The Smashing Pumpkins"},
  {album:"The Score", artist:"Fugees"},
  {album:"The Miseducation of Lauryn Hill", artist:"Ms. Lauryn Hill"},
  {album:"Either/Or", artist:"Elliott Smith"},
  {album:"Purple Rain", artist:"Prince"},
  {album:"The K√∂ln Concert", artist:"Keith Jarrett"},
  {album:"The Joshua Tree", artist:"U2"},
  {album:"London Calling", artist:"The Clash"},
  {album:"The Velvet Underground & Nico", artist:"The Velvet Underground"},
  {album:"Are You Experienced", artist:"Jimi Hendrix"},
  {album:"Back To Black", artist:"Amy Winehouse"},
  {album:"Back In Black", artist:"AC/DC"},
  {album:"Parallel Lines", artist:"Blondie"},
  {album:"Origin of Symmetry", artist:"Muse"},
  {album:"Out Of Time", artist:"R.E.M."},
  {album:"Sea Change", artist:"Beck"},
  {album:"AM", artist:"Arctic Monkeys"},
  {album:"Lost In The Dream", artist:"The War On Drugs"},
  {album:"Is This It", artist:"The Strokes"},
  {album:"Arrival", artist:"ABBA"},
  {album:"Parachutes", artist:"Coldplay"},
  {album:"What's the Story Morning Glory", artist:"Oasis"},
  {album:"Jagged Little Pill", artist:"Alanis Morissette"},
  {album:"Je Dis Aime", artist:"-M-"},
  {album:"Samedi soir sur la terre", artist:"Francis Cabrel"},
  {album:"After Hours", artist:"The Weeknd"},
  {album:"1989", artist:"Taylor Swift"},
  {album:"No Need to Argue", artist:"The Cranberries"},
  {album:"Thriller", artist:"Michael Jackson"},
  {album:"Hurry Up We're Dreaming", artist:"M83"},
  {album:"Oracular Spectacular", artist:"MGMT"},
  {album:"Californication", artist:"Red Hot Chili Peppers"},
  {album:"Starmania", artist:"France Gall"},
];

let albums = [], queue = [], currentVideoId = null, ytPlayer = null, ytReady = false;
let progressInterval = null, shuffleOn = false, openAlbumIdx = -1;

function showToast(msg, color='#1DB954') {
  const t = document.getElementById('toast');
  t.style.background = color; t.textContent = msg;
  t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000);
}

// YouTube
window.onYouTubeIframeAPIReady = () => {
  ytReady = true;
  ytPlayer = new YT.Player('yt-player', {
    height:'0', width:'0',
    events: {
      onStateChange: e => {
        if (e.data === YT.PlayerState.ENDED) playNext();
        if (e.data === YT.PlayerState.PLAYING) { document.getElementById('playBtn').textContent='‚è∏'; startProgress(); }
        if (e.data === YT.PlayerState.PAUSED) document.getElementById('playBtn').textContent='‚ñ∂';
      }
    }
  });
};
const ytTag = document.createElement('script');
ytTag.src = 'https://www.youtube.com/iframe_api';
document.head.appendChild(ytTag);

function startProgress() {
  if (progressInterval) clearInterval(progressInterval);
  progressInterval = setInterval(() => {
    if (!ytPlayer?.getCurrentTime) return;
    const c = ytPlayer.getCurrentTime(), d = ytPlayer.getDuration();
    if (d > 0) document.getElementById('progressFill').style.width = (c/d*100)+'%';
  }, 1000);
}

// Search YouTube for playlist
async function searchAlbumPlaylist(artist, album) {
  const q = `${artist} ${album} full album`;
  const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=playlist&q=${encodeURIComponent(q)}&maxResults=3&key=${YT_KEY}`;
  const data = await fetch(url).then(r=>r.json());
  return data.items?.[0]?.id?.playlistId || null;
}

// Get tracks from playlist
async function getPlaylistTracks(playlistId) {
  const url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${playlistId}&maxResults=50&key=${YT_KEY}`;
  const data = await fetch(url).then(r=>r.json());
  if (!data.items) return [];
  return data.items
    .filter(i => i.snippet.resourceId?.videoId && i.snippet.title !== 'Private video' && i.snippet.title !== 'Deleted video')
    .map((i, idx) => ({
      num: idx + 1,
      name: i.snippet.title,
      videoId: i.snippet.resourceId.videoId,
      thumb: i.snippet.thumbnails?.medium?.url || i.snippet.thumbnails?.default?.url || ''
    }));
}

// Get album cover
async function getAlbumThumb(playlistId) {
  const url = `https://www.googleapis.com/youtube/v3/playlists?part=snippet&id=${playlistId}&key=${YT_KEY}`;
  const data = await fetch(url).then(r=>r.json());
  return data.items?.[0]?.snippet?.thumbnails?.medium?.url || data.items?.[0]?.snippet?.thumbnails?.default?.url || '';
}

// Load all albums
async function loadAlbums() {
  // Try cache
  try {
    const cached = localStorage.getItem(CACHE_KEY);
    if (cached) { albums = JSON.parse(cached); renderAlbums(); return; }
  } catch(e) {}

  const loading = document.getElementById('loadingSection');
  const fill = document.getElementById('loadingFill');
  const text = document.getElementById('loadingText');
  loading.style.display = 'block';
  albums = [];

  for (let i = 0; i < PLAYLIST.length; i++) {
    const p = PLAYLIST[i];
    const pct = Math.round((i+1)/PLAYLIST.length*100);
    fill.style.width = pct+'%';
    text.textContent = `Chargement ${pct}% ‚Äî ${p.artist} - ${p.album}`;

    try {
      const plId = await searchAlbumPlaylist(p.artist, p.album);
      if (plId) {
        const [tracks, thumb] = await Promise.all([getPlaylistTracks(plId), getAlbumThumb(plId)]);
        if (tracks.length > 0) {
          albums.push({ name: p.album, artist: p.artist, thumb, playlistId: plId, tracks });
        }
      }
    } catch(e) { console.warn('Error loading', p.album, e); }

    await new Promise(r => setTimeout(r, 150));
  }

  loading.style.display = 'none';
  localStorage.setItem(CACHE_KEY, JSON.stringify(albums));
  renderAlbums();
  showToast(`${albums.length} albums charg√©s !`);
}

function renderAlbums() {
  document.getElementById('albumCount').textContent = albums.length;
  const grid = document.getElementById('albumsGrid');
  if (!albums.length) { grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#555;padding:20px;">Aucun album</div>'; return; }
  grid.innerHTML = albums.map((a,i) => `
    <div class="album-card" id="alb_${i}" onclick="openAlbum(${i})">
      <span class="track-count">${a.tracks.length}</span>
      <img src="${a.thumb}" alt="${a.name}" loading="lazy" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect fill=%22%23222%22 width=%22100%22 height=%22100%22/><text fill=%22%23666%22 font-size=%2228%22 x=%2250%22 y=%2257%22 text-anchor=%22middle%22>üéµ</text></svg>'">
      <div class="album-name">${a.name}</div>
      <div class="album-artist">${a.artist}</div>
    </div>`).join('');
}

function openAlbum(idx) {
  openAlbumIdx = idx;
  const a = albums[idx];
  document.getElementById('panelTitle').textContent = a.name;
  document.getElementById('panelSub').textContent = `${a.artist} ¬∑ ${a.tracks.length} titres`;
  
  const queuedIds = new Set(queue.map(q => q.videoId));
  document.getElementById('tracksList').innerHTML = a.tracks.map(t => `
    <div class="track-item ${queuedIds.has(t.videoId)?'in-queue':''}" id="track_${t.videoId}" onclick="addToQueue(${idx},${t.num-1})">
      <span class="track-num">${String(t.num).padStart(2,'0')}</span>
      <span class="track-name">${t.name}</span>
      <span class="add-indicator ${queuedIds.has(t.videoId)?'added':''}">‚úì</span>
    </div>`).join('');
  
  document.getElementById('trackPanel').classList.add('open');
}

function closePanel() { document.getElementById('trackPanel').classList.remove('open'); }

function addToQueue(albumIdx, trackIdx) {
  const track = albums[albumIdx].tracks[trackIdx];
  const album = albums[albumIdx];
  
  queue.push({ videoId: track.videoId, name: track.name, artist: album.artist, albumName: album.name });
  
  // Visual feedback
  const el = document.getElementById('track_'+track.videoId);
  if (el) { el.classList.add('in-queue','added'); }
  
  renderQueue();
  showToast(`"${track.name}" ajout√© √† la queue !`);
  
  // If nothing is playing, start
  if (!currentVideoId) playNext();
}

function renderQueue() {
  const sec = document.getElementById('queueSection');
  document.getElementById('queueCount').textContent = queue.length;
  if (!queue.length) { sec.style.display='none'; return; }
  sec.style.display = 'block';
  document.getElementById('queueList').innerHTML = queue.map((q,i) => `
    <div class="queue-item ${i===0&&currentVideoId?'active':''}">üéµ ${q.name}</div>`).join('');
}

function playNext() {
  if (!queue.length) { currentVideoId = null; document.getElementById('playBtn').textContent='‚ñ∂'; return; }
  const next = queue.shift();
  currentVideoId = next.videoId;
  document.getElementById('npTitle').textContent = next.name;
  document.getElementById('npArtist').textContent = `${next.artist} ‚Äî ${next.albumName}`;
  renderQueue();
  if (ytReady && ytPlayer) { ytPlayer.loadVideoById(next.videoId); ytPlayer.playVideo(); }
}

function skipQueue() { playNext(); }

function clearQueue() {
  queue = [];
  renderQueue();
  showToast('Queue vid√©e', '#c8860a');
}

function togglePlay() {
  if (!ytPlayer || !ytReady) return;
  ytPlayer.getPlayerState() === YT.PlayerState.PLAYING ? ytPlayer.pauseVideo() : ytPlayer.playVideo();
}

function toggleShuffle() {
  shuffleOn = !shuffleOn;
  document.getElementById('shuffleBtn').style.background = shuffleOn ? '#1DB954' : '#c8860a';
  showToast(shuffleOn ? 'Al√©atoire activ√©' : 'D√©sactiv√©');
}

loadAlbums();
</script>
</body>
</html>
