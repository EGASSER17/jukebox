<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mon Jukebox</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #1a0a00; color: #f0e0c0; font-family: 'Georgia', serif; min-height: 100vh; }
  .machine {
    max-width: 480px; margin: 0 auto;
    background: linear-gradient(180deg, #8B1A00 0%, #5C1100 40%, #3a0a00 100%);
    min-height: 100vh;
    border-left: 6px solid #c8860a; border-right: 6px solid #c8860a;
    box-shadow: 0 0 40px #c8860a55;
    display: flex; flex-direction: column;
  }
  .header { background: linear-gradient(90deg, #c8860a, #f5c842, #c8860a); padding: 18px; text-align: center; border-bottom: 4px solid #8B1A00; }
  .header h1 { font-size: 2rem; color: #1a0a00; text-shadow: 1px 1px 0 #f5c842; letter-spacing: 4px; text-transform: uppercase; }
  .screen { background: #0a1a0a; margin: 16px; border-radius: 8px; border: 3px solid #c8860a; padding: 14px; min-height: 100px; box-shadow: inset 0 0 20px #00000088; }
  .now-playing-label { font-size: .65rem; color: #c8860a; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 6px; }
  .now-playing-title { font-size: 1.1rem; color: #7fff7f; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .now-playing-artist { font-size: .85rem; color: #aaffaa; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .progress-bar { background: #1a3a1a; border-radius: 4px; height: 6px; margin-top: 10px; overflow: hidden; }
  .progress-fill { background: #7fff7f; height: 100%; width: 0%; transition: width 1s linear; }
  .controls { display: flex; justify-content: center; gap: 16px; margin: 8px 16px; }
  .ctrl-btn { background: #c8860a; border: none; border-radius: 50%; width: 44px; height: 44px; font-size: 1.2rem; cursor: pointer; color: #1a0a00; transition: background .15s; box-shadow: 0 3px 8px #00000066; }
  .ctrl-btn:hover { background: #f5c842; }
  .albums-section { flex: 1; margin: 0 16px; overflow: hidden; display: flex; flex-direction: column; }
  .albums-label { font-size: .65rem; color: #c8860a; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 8px; }
  .albums-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; overflow-y: auto; flex: 1; padding-bottom: 10px; }
  .albums-grid::-webkit-scrollbar { width: 4px; }
  .albums-grid::-webkit-scrollbar-track { background: #3a0a00; }
  .albums-grid::-webkit-scrollbar-thumb { background: #c8860a; border-radius: 2px; }
  .album-card { cursor: pointer; border-radius: 6px; overflow: hidden; border: 2px solid transparent; transition: border .15s, transform .15s; }
  .album-card:hover { border-color: #f5c842; transform: scale(1.04); }
  .album-card.selected { border-color: #7fff7f; }
  .album-card img { width: 100%; aspect-ratio: 1; display: block; background: #333; }
  .album-name { font-size: .6rem; text-align: center; padding: 3px 2px; background: #1a0a00; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .tracks-panel { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: #1a0a00; border-top: 3px solid #c8860a; border-left: 6px solid #c8860a; border-right: 6px solid #c8860a; max-height: 60vh; overflow-y: auto; z-index: 100; display: none; padding-bottom: 10px; }
  .tracks-panel.open { display: block; }
  .tracks-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #3a0a00; position: sticky; top: 0; }
  .tracks-header h3 { font-size: .9rem; color: #f5c842; }
  .close-btn { background: none; border: none; color: #c8860a; font-size: 1.4rem; cursor: pointer; }
  .track-item { display: flex; align-items: center; gap: 10px; padding: 10px 16px; border-bottom: 1px solid #3a0a0044; cursor: pointer; transition: background .1s; }
  .track-item:hover { background: #3a0a00; }
  .track-num { font-size: .75rem; color: #c8860a; min-width: 22px; text-align: right; }
  .track-info { flex: 1; overflow: hidden; }
  .track-title { font-size: .85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .track-duration { font-size: .7rem; color: #c8860a; }
  .queue-btn { background: #c8860a; border: none; border-radius: 4px; padding: 4px 8px; font-size: .7rem; color: #1a0a00; cursor: pointer; font-weight: bold; margin-left: 4px; }
  .queue-btn:hover { background: #f5c842; }
  .login-screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; padding: 20px; }
  .login-screen p { text-align: center; color: #c8860a; font-size: .9rem; }
  .login-btn { background: linear-gradient(90deg,#1DB954,#1aa34a); color: white; border: none; padding: 14px 32px; border-radius: 30px; font-size: 1rem; font-weight: bold; cursor: pointer; letter-spacing: 1px; box-shadow: 0 4px 15px #1DB95455; }
  .login-btn:hover { background: linear-gradient(90deg,#1aa34a,#1DB954); }
  .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1DB954; color: white; padding: 10px 20px; border-radius: 20px; font-size: .85rem; opacity: 0; transition: opacity .3s; z-index: 200; white-space: nowrap; }
  .toast.show { opacity: 1; }
  .playlist-input-section { margin: 0 16px 12px; display: flex; gap: 8px; }
  .playlist-input { flex: 1; background: #0a1a0a; border: 2px solid #c8860a; border-radius: 6px; color: #f0e0c0; padding: 8px 10px; font-size: .8rem; outline: none; }
  .playlist-input::placeholder { color: #666; }
  .load-btn { background: #c8860a; border: none; border-radius: 6px; color: #1a0a00; padding: 8px 12px; font-size: .8rem; font-weight: bold; cursor: pointer; }
  .load-btn:hover { background: #f5c842; }
  .queue-section { margin: 0 16px 12px; }
  .queue-label { font-size: .65rem; color: #c8860a; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 6px; }
  .queue-list { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; }
  .queue-list::-webkit-scrollbar { height: 3px; }
  .queue-list::-webkit-scrollbar-thumb { background: #c8860a; border-radius: 2px; }
  .queue-item { flex-shrink: 0; background: #3a0a00; border-radius: 4px; padding: 4px 8px; font-size: .7rem; color: #f0e0c0; max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
</style>
</head>
<body>
<div class="machine">
  <div class="header"><h1>üéµ Jukebox</h1></div>
  <div class="login-screen" id="loginScreen">
    <p>Connecte-toi avec Spotify<br>pour lancer le jukebox</p>
    <button class="login-btn" onclick="login()">Connexion Spotify</button>
  </div>
  <div id="mainApp" style="display:none;flex-direction:column;flex:1;">
    <div class="screen">
      <div class="now-playing-label">‚ñ∂ En cours</div>
      <div class="now-playing-title" id="trackTitle">‚Äî</div>
      <div class="now-playing-artist" id="trackArtist">‚Äî</div>
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    </div>
    <div class="controls">
      <button class="ctrl-btn" onclick="prevTrack()">‚èÆ</button>
      <button class="ctrl-btn" id="playBtn" onclick="togglePlay()">‚ñ∂</button>
      <button class="ctrl-btn" onclick="nextTrack()">‚è≠</button>
      <button class="ctrl-btn" id="shuffleBtn" onclick="toggleShuffle()">üîÄ</button>
    </div>
    <div class="queue-section" id="queueSection" style="display:none;">
      <div class="queue-label">File d'attente</div>
      <div class="queue-list" id="queueList"></div>
    </div>
    <div class="playlist-input-section">
      <input class="playlist-input" id="playlistUrl" placeholder="Lien playlist Spotify..." />
      <button class="load-btn" onclick="loadPlaylist()">Charger</button>
    </div>
    <div class="albums-section">
      <div class="albums-label">Albums</div>
      <div class="albums-grid" id="albumsGrid">
        <div style="grid-column:1/-1;text-align:center;color:#666;font-size:.8rem;padding:20px;">Charge une playlist Spotify pour voir les albums</div>
      </div>
    </div>
  </div>
</div>

<div class="tracks-panel" id="tracksPanel">
  <div class="tracks-header">
    <h3 id="panelAlbumName">Titres</h3>
    <button class="close-btn" onclick="closeTracks()">‚úï</button>
  </div>
  <div id="tracksList"></div>
</div>

<div class="toast" id="toast"></div>

<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script>
const CLIENT_ID = '3fcf4320b95b432f9271cbfd97c40b22';
const REDIRECT_URI = 'https://egasser17.github.io/jukebox/';
const SCOPES = 'streaming user-read-email user-read-private user-modify-playback-state user-read-playback-state playlist-read-private playlist-read-collaborative';

let token = null, player = null, deviceId = null;
let albums = [], queue = [], shuffleOn = false;

// PKCE helpers
function b64(buf) {
  return btoa(String.fromCharCode(...new Uint8Array(buf)))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=/g,'');
}
async function pkce() {
  const verifier = b64(crypto.getRandomValues(new Uint8Array(32)));
  const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(verifier));
  return { verifier, challenge: b64(hash) };
}

async function login() {
  const { verifier, challenge } = await pkce();
  sessionStorage.setItem('pkce_verifier', verifier);
  const url = new URL('https://accounts.spotify.com/authorize');
  url.searchParams.set('client_id', CLIENT_ID);
  url.searchParams.set('response_type', 'code');
  url.searchParams.set('redirect_uri', REDIRECT_URI);
  url.searchParams.set('scope', SCOPES);
  url.searchParams.set('code_challenge_method', 'S256');
  url.searchParams.set('code_challenge', challenge);
  window.location.href = url.toString();
}

async function getToken(code) {
  const verifier = sessionStorage.getItem('pkce_verifier');
  const res = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({ grant_type: 'authorization_code', code, redirect_uri: REDIRECT_URI, client_id: CLIENT_ID, code_verifier: verifier })
  });
  const data = await res.json();
  return data.access_token;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

async function api(endpoint, method='GET', body=null) {
  const opts = { method, headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(`https://api.spotify.com/v1${endpoint}`, opts);
  if (res.status === 204) return null;
  return res.json();
}

async function loadPlaylist() {
  const url = document.getElementById('playlistUrl').value.trim();
  const match = url.match(/playlist\/([a-zA-Z0-9]+)/);
  if (!match) { showToast('Lien invalide !'); return; }
  showToast('Chargement...');
  let tracks = [], next = `/playlists/${match[1]}/tracks?limit=100`;
  while (next) {
    const data = await api(next.replace('https://api.spotify.com/v1',''));
    tracks = tracks.concat(data.items.filter(i => i.track?.album));
    next = data.next ? data.next.replace('https://api.spotify.com/v1','') : null;
  }
  const map = {};
  tracks.forEach(({track: t}) => {
    const a = t.album;
    if (!map[a.id]) map[a.id] = { id: a.id, name: a.name, artist: a.artists[0].name, img: a.images[1]?.url||a.images[0]?.url, tracks: [] };
    map[a.id].tracks.push({ uri: t.uri, name: t.name, duration: t.duration_ms });
  });
  albums = Object.values(map).slice(0,100);
  renderAlbums();
  showToast(`${albums.length} albums charg√©s !`);
}

function renderAlbums() {
  document.getElementById('albumsGrid').innerHTML = albums.map((a,i) => `
    <div class="album-card" id="alb_${i}" onclick="openAlbum(${i})">
      <img src="${a.img}" alt="${a.name}" loading="lazy">
      <div class="album-name">${a.name}</div>
    </div>`).join('');
}

function openAlbum(i) {
  const a = albums[i];
  document.querySelectorAll('.album-card').forEach(c => c.classList.remove('selected'));
  document.getElementById('alb_'+i)?.classList.add('selected');
  document.getElementById('panelAlbumName').textContent = a.name;
  document.getElementById('tracksList').innerHTML = a.tracks.map((t,j) => `
    <div class="track-item">
      <div class="track-num">${j+1}</div>
      <div class="track-info">
        <div class="track-title">${t.name}</div>
        <div class="track-duration">${fmt(t.duration)}</div>
      </div>
      <button class="queue-btn" onclick="addToQueue('${t.uri}','${t.name.replace(/'/g,"\\'")}')">+</button>
      <button class="queue-btn" onclick="playNow('${t.uri}')">‚ñ∂</button>
    </div>`).join('');
  document.getElementById('tracksPanel').classList.add('open');
}

function closeTracks() { document.getElementById('tracksPanel').classList.remove('open'); }
function fmt(ms) { const s=Math.floor(ms/1000),m=Math.floor(s/60); return `${m}:${String(s%60).padStart(2,'0')}`; }

async function playNow(uri) {
  if (!deviceId) { showToast('Player pas pr√™t'); return; }
  await api(`/me/player/play?device_id=${deviceId}`,'PUT',{uris:[uri]});
  closeTracks(); showToast('Lecture lanc√©e !');
}

async function addToQueue(uri, name) {
  if (!deviceId) { showToast('Player pas pr√™t'); return; }
  await api(`/me/player/queue?uri=${encodeURIComponent(uri)}`,'POST');
  queue.push(name); renderQueue();
  showToast(`"${name}" ajout√© !`);
}

function renderQueue() {
  const sec = document.getElementById('queueSection');
  if (!queue.length) { sec.style.display='none'; return; }
  sec.style.display='block';
  document.getElementById('queueList').innerHTML = queue.map(n=>`<div class="queue-item">üéµ ${n}</div>`).join('');
}

async function togglePlay() { player?.togglePlay(); }
async function nextTrack() { deviceId && await api('/me/player/next','POST'); }
async function prevTrack() { deviceId && await api('/me/player/previous','POST'); }
async function toggleShuffle() {
  shuffleOn = !shuffleOn;
  await api(`/me/player/shuffle?state=${shuffleOn}`,'PUT');
  document.getElementById('shuffleBtn').style.background = shuffleOn ? '#1DB954' : '#c8860a';
  showToast(shuffleOn ? 'Al√©atoire activ√©' : 'Al√©atoire d√©sactiv√©');
}

function initPlayer() {
  if (!token || !window.Spotify) { setTimeout(initPlayer, 500); return; }
  player = new Spotify.Player({ name: 'Mon Jukebox', getOAuthToken: cb => cb(token), volume: 0.8 });
  player.addListener('ready', ({ device_id }) => {
    deviceId = device_id;
    api('/me/player','PUT',{ device_ids:[device_id] });
    showToast('Jukebox pr√™t !');
  });
  player.addListener('player_state_changed', state => {
    if (!state) return;
    const t = state.track_window.current_track;
    document.getElementById('trackTitle').textContent = t.name;
    document.getElementById('trackArtist').textContent = t.artists.map(a=>a.name).join(', ');
    document.getElementById('playBtn').textContent = state.paused ? '‚ñ∂' : '‚è∏';
    document.getElementById('progressFill').style.width = (state.position/state.duration*100)+'%';
    if (queue.length) { queue.shift(); renderQueue(); }
  });
  player.connect();
};

async function init() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  const saved = sessionStorage.getItem('spotify_token');
  if (code) {
    window.history.replaceState({}, '', window.location.pathname);
    token = await getToken(code);
    sessionStorage.setItem('spotify_token', token);
    console.log('Token obtenu:', token ? 'OK' : 'ECHEC');
    showApp();
  } else if (saved) {
    token = saved;
    showApp();
  }
}

function showApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'flex';
}

init();
</script>
</body>
</html>
