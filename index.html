<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mon Jukebox</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #1a0a00; color: #f0e0c0; font-family: 'Georgia', serif; min-height: 100vh; }
  .machine { max-width: 480px; margin: 0 auto; background: linear-gradient(180deg,#8B1A00 0%,#5C1100 40%,#3a0a00 100%); min-height: 100vh; border-left: 6px solid #c8860a; border-right: 6px solid #c8860a; box-shadow: 0 0 40px #c8860a55; display: flex; flex-direction: column; }
  .header { background: linear-gradient(90deg,#c8860a,#f5c842,#c8860a); padding: 18px; text-align: center; border-bottom: 4px solid #8B1A00; }
  .header h1 { font-size: 2rem; color: #1a0a00; text-shadow: 1px 1px 0 #f5c842; letter-spacing: 4px; text-transform: uppercase; }
  .screen { background: #0a1a0a; margin: 16px; border-radius: 8px; border: 3px solid #c8860a; padding: 14px; box-shadow: inset 0 0 20px #00000088; }
  .now-playing-label { font-size: .65rem; color: #c8860a; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 6px; }
  .now-playing-title { font-size: 1.1rem; color: #7fff7f; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .now-playing-artist { font-size: .85rem; color: #aaffaa; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .progress-bar { background: #1a3a1a; border-radius: 4px; height: 6px; margin-top: 10px; overflow: hidden; cursor: pointer; }
  .progress-fill { background: #7fff7f; height: 100%; width: 0%; transition: width 1s linear; }
  #yt-player { display: none; }
  .controls { display: flex; justify-content: center; gap: 16px; margin: 8px 16px; }
  .ctrl-btn { background: #c8860a; border: none; border-radius: 50%; width: 44px; height: 44px; font-size: 1.2rem; cursor: pointer; color: #1a0a00; transition: background .15s; box-shadow: 0 3px 8px #00000066; }
  .ctrl-btn:hover { background: #f5c842; }
  .section { margin: 0 16px 12px; }
  .section-label { font-size: .65rem; color: #c8860a; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 8px; }
  .search-row { display: flex; gap: 8px; }
  .search-input { flex: 1; background: #0a1a0a; border: 2px solid #c8860a; border-radius: 6px; color: #f0e0c0; padding: 8px 10px; font-size: .85rem; outline: none; }
  .search-input::placeholder { color: #555; }
  .search-btn { background: #c8860a; border: none; border-radius: 6px; color: #1a0a00; padding: 8px 14px; font-size: .9rem; font-weight: bold; cursor: pointer; }
  .search-btn:hover { background: #f5c842; }
  .albums-section { flex: 1; margin: 0 16px; overflow: hidden; display: flex; flex-direction: column; }
  .albums-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; overflow-y: auto; flex: 1; padding-bottom: 10px; }
  .albums-grid::-webkit-scrollbar { width: 4px; }
  .albums-grid::-webkit-scrollbar-thumb { background: #c8860a; border-radius: 2px; }
  .album-card { cursor: pointer; border-radius: 6px; overflow: hidden; border: 2px solid transparent; transition: border .15s, transform .15s; position: relative; }
  .album-card:hover { border-color: #f5c842; transform: scale(1.04); }
  .album-card.selected { border-color: #7fff7f; }
  .album-card img { width: 100%; aspect-ratio: 1; display: block; object-fit: cover; background: #333; }
  .album-name { font-size: .6rem; text-align: center; padding: 3px 2px; background: #1a0a00; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .album-artist { font-size: .55rem; text-align: center; padding: 0 2px 3px; background: #1a0a00; color: #c8860a; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .remove-btn { position: absolute; top: 3px; right: 3px; background: #8B1A00cc; border: none; border-radius: 50%; width: 20px; height: 20px; color: #f5c842; font-size: .7rem; cursor: pointer; display: none; align-items: center; justify-content: center; }
  .album-card:hover .remove-btn { display: flex; }
  .tracks-panel { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: #1a0a00; border-top: 3px solid #c8860a; border-left: 6px solid #c8860a; border-right: 6px solid #c8860a; max-height: 65vh; overflow-y: auto; z-index: 100; display: none; padding-bottom: 10px; }
  .tracks-panel.open { display: block; }
  .tracks-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #3a0a00; position: sticky; top: 0; }
  .tracks-header h3 { font-size: .9rem; color: #f5c842; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .close-btn { background: none; border: none; color: #c8860a; font-size: 1.4rem; cursor: pointer; }
  .track-item { display: flex; align-items: center; gap: 10px; padding: 10px 16px; border-bottom: 1px solid #3a0a0044; transition: background .1s; }
  .track-item:hover { background: #3a0a00; }
  .track-item.playing { background: #0a3a0a; }
  .track-num { font-size: .75rem; color: #c8860a; min-width: 22px; text-align: right; }
  .track-info { flex: 1; overflow: hidden; }
  .track-title { font-size: .85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .play-btn { background: #c8860a; border: none; border-radius: 4px; padding: 5px 10px; font-size: .75rem; color: #1a0a00; cursor: pointer; font-weight: bold; }
  .play-btn:hover { background: #f5c842; }
  .search-results { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: #1a0a00; border-top: 3px solid #c8860a; border-left: 6px solid #c8860a; border-right: 6px solid #c8860a; max-height: 65vh; overflow-y: auto; z-index: 101; display: none; padding-bottom: 10px; }
  .search-results.open { display: block; }
  .result-item { display: flex; align-items: center; gap: 10px; padding: 10px 16px; border-bottom: 1px solid #3a0a0044; cursor: pointer; transition: background .1s; }
  .result-item:hover { background: #3a0a00; }
  .result-img { width: 48px; height: 48px; border-radius: 4px; object-fit: cover; flex-shrink: 0; }
  .result-info { flex: 1; overflow: hidden; }
  .result-title { font-size: .85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .result-sub { font-size: .7rem; color: #c8860a; }
  .add-btn { background: #c8860a; border: none; border-radius: 4px; padding: 5px 10px; font-size: .75rem; color: #1a0a00; cursor: pointer; font-weight: bold; flex-shrink: 0; }
  .add-btn:hover { background: #f5c842; }
  .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1DB954; color: white; padding: 10px 20px; border-radius: 20px; font-size: .85rem; opacity: 0; transition: opacity .3s; z-index: 300; white-space: nowrap; }
  .toast.show { opacity: 1; }
  .queue-section { margin: 0 16px 8px; }
  .queue-list { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; }
  .queue-list::-webkit-scrollbar { height: 3px; }
  .queue-list::-webkit-scrollbar-thumb { background: #c8860a; border-radius: 2px; }
  .queue-item { flex-shrink: 0; background: #3a0a00; border-radius: 4px; padding: 4px 8px; font-size: .7rem; max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
</style>
</head>
<body>
<div id="yt-player"></div>
<div class="machine">
  <div class="header"><h1>üéµ Jukebox</h1></div>

  <div class="screen">
    <div class="now-playing-label">‚ñ∂ En cours</div>
    <div class="now-playing-title" id="trackTitle">‚Äî</div>
    <div class="now-playing-artist" id="trackArtist">‚Äî</div>
    <div class="progress-bar" id="progressBar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>

  <div class="controls">
    <button class="ctrl-btn" onclick="prevTrack()">‚èÆ</button>
    <button class="ctrl-btn" id="playBtn" onclick="togglePlay()">‚ñ∂</button>
    <button class="ctrl-btn" onclick="nextTrack()">‚è≠</button>
    <button class="ctrl-btn" id="shuffleBtn" onclick="toggleShuffle()">üîÄ</button>
  </div>

  <div class="queue-section" id="queueSection" style="display:none;">
    <div class="section-label">File d'attente</div>
    <div class="queue-list" id="queueList"></div>
  </div>

  <div class="section">
    <div class="section-label">Rechercher un album</div>
    <div class="search-row">
      <input class="search-input" id="searchInput" placeholder="Artiste ou album..." onkeydown="if(event.key==='Enter') search()" />
      <button class="search-btn" onclick="search()">üîç</button>
    </div>
  </div>

  <div class="albums-section">
    <div class="section-label">Mon Jukebox (<span id="albumCount">0</span> albums)</div>
    <div class="albums-grid" id="albumsGrid">
      <div style="grid-column:1/-1;text-align:center;color:#555;font-size:.8rem;padding:30px;">
        Recherche un album pour commencer üéµ
      </div>
    </div>
  </div>
</div>

<!-- Tracks Panel -->
<div class="tracks-panel" id="tracksPanel">
  <div class="tracks-header">
    <h3 id="panelAlbumName">Titres</h3>
    <button class="close-btn" onclick="closeTracks()">‚úï</button>
  </div>
  <div id="tracksList"></div>
</div>

<!-- Search Results -->
<div class="search-results" id="searchResults">
  <div class="tracks-header">
    <h3>R√©sultats</h3>
    <button class="close-btn" onclick="closeSearch()">‚úï</button>
  </div>
  <div id="resultsList"></div>
</div>

<div class="toast" id="toast"></div>

<script>
const YT_KEY = 'AIzaSyAWXE17MurvNcrGZMKH1d-X6aY6IF3Z_lw';
let ytPlayer = null, ytReady = false;
let albums = [], queue = [], currentAlbumIdx = -1, currentTrackIdx = -1, shuffleOn = false;
let progressInterval = null;

// Load saved jukebox
function loadSaved() {
  try { albums = JSON.parse(localStorage.getItem('jukebox_albums') || '[]'); } catch(e) { albums = []; }
  renderAlbums();
}

function save() {
  localStorage.setItem('jukebox_albums', JSON.stringify(albums));
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// YouTube IFrame API
window.onYouTubeIframeAPIReady = () => {
  ytReady = true;
  ytPlayer = new YT.Player('yt-player', {
    height: '0', width: '0',
    playerVars: { autoplay: 0 },
    events: {
      onStateChange: e => {
        if (e.data === YT.PlayerState.ENDED) nextTrack();
        if (e.data === YT.PlayerState.PLAYING) {
          document.getElementById('playBtn').textContent = '‚è∏';
          startProgress();
        }
        if (e.data === YT.PlayerState.PAUSED) {
          document.getElementById('playBtn').textContent = '‚ñ∂';
        }
      }
    }
  });
};

function startProgress() {
  if (progressInterval) clearInterval(progressInterval);
  progressInterval = setInterval(() => {
    if (!ytPlayer || typeof ytPlayer.getCurrentTime !== 'function') return;
    const cur = ytPlayer.getCurrentTime(), dur = ytPlayer.getDuration();
    if (dur > 0) document.getElementById('progressFill').style.width = (cur/dur*100)+'%';
  }, 1000);
}

// Search YouTube
async function search() {
  const q = document.getElementById('searchInput').value.trim();
  if (!q) return;
  showToast('Recherche...');
  const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(q)}&maxResults=10&key=${YT_KEY}`;
  const data = await fetch(url).then(r => r.json());
  if (!data.items) { showToast('Erreur de recherche'); return; }
  
  const list = document.getElementById('resultsList');
  list.innerHTML = data.items.map(item => `
    <div class="result-item">
      <img class="result-img" src="${item.snippet.thumbnails.default.url}" alt="">
      <div class="result-info">
        <div class="result-title">${item.snippet.title}</div>
        <div class="result-sub">${item.snippet.channelTitle}</div>
      </div>
      <button class="add-btn" onclick="addToJukebox('${item.id.videoId}','${item.snippet.title.replace(/'/g,"\\'")}','${item.snippet.channelTitle.replace(/'/g,"\\'")}','${item.snippet.thumbnails.medium?.url||item.snippet.thumbnails.default.url}')">+ Ajouter</button>
    </div>
  `).join('');
  document.getElementById('searchResults').classList.add('open');
}

function closeSearch() { document.getElementById('searchResults').classList.remove('open'); }

function addToJukebox(videoId, title, channel, thumb) {
  // Check if already added
  if (albums.find(a => a.id === videoId)) { showToast('D√©j√† dans le jukebox !'); return; }
  albums.push({ id: videoId, name: title, artist: channel, img: thumb, tracks: [{ id: videoId, name: title }] });
  save();
  renderAlbums();
  showToast(`"${title.substring(0,30)}..." ajout√© !`);
}

function removeFromJukebox(idx, e) {
  e.stopPropagation();
  albums.splice(idx, 1);
  save();
  renderAlbums();
  showToast('Retir√© du jukebox');
}

function renderAlbums() {
  document.getElementById('albumCount').textContent = albums.length;
  const grid = document.getElementById('albumsGrid');
  if (!albums.length) {
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#555;font-size:.8rem;padding:30px;">Recherche un album pour commencer üéµ</div>';
    return;
  }
  grid.innerHTML = albums.map((a,i) => `
    <div class="album-card" id="alb_${i}" onclick="playAlbum(${i})">
      <button class="remove-btn" onclick="removeFromJukebox(${i}, event)">‚úï</button>
      <img src="${a.img}" alt="${a.name}" loading="lazy">
      <div class="album-name">${a.name}</div>
      <div class="album-artist">${a.artist}</div>
    </div>`).join('');
}

function playAlbum(idx) {
  currentAlbumIdx = idx;
  currentTrackIdx = 0;
  playCurrentTrack();
  closeTracks();
  closeSearch();
}

function playCurrentTrack() {
  if (currentAlbumIdx < 0 || currentAlbumIdx >= albums.length) return;
  const album = albums[currentAlbumIdx];
  const track = album.tracks[currentTrackIdx];
  if (!track) return;
  document.getElementById('trackTitle').textContent = track.name;
  document.getElementById('trackArtist').textContent = album.artist;
  document.querySelectorAll('.album-card').forEach(c => c.classList.remove('selected'));
  document.getElementById('alb_'+currentAlbumIdx)?.classList.add('selected');
  if (ytReady && ytPlayer) {
    ytPlayer.loadVideoById(track.id);
    ytPlayer.playVideo();
  }
  if (queue.length > 0) { queue.shift(); renderQueue(); }
}

function togglePlay() {
  if (!ytPlayer || !ytReady) return;
  const state = ytPlayer.getPlayerState();
  if (state === YT.PlayerState.PLAYING) ytPlayer.pauseVideo();
  else ytPlayer.playVideo();
}

function nextTrack() {
  if (queue.length > 0) {
    const next = queue[0];
    currentAlbumIdx = next.albumIdx;
    currentTrackIdx = 0;
    playCurrentTrack();
    return;
  }
  if (shuffleOn) {
    currentAlbumIdx = Math.floor(Math.random() * albums.length);
  } else {
    currentAlbumIdx = (currentAlbumIdx + 1) % albums.length;
  }
  currentTrackIdx = 0;
  playCurrentTrack();
}

function prevTrack() {
  currentAlbumIdx = (currentAlbumIdx - 1 + albums.length) % albums.length;
  currentTrackIdx = 0;
  playCurrentTrack();
}

function toggleShuffle() {
  shuffleOn = !shuffleOn;
  document.getElementById('shuffleBtn').style.background = shuffleOn ? '#1DB954' : '#c8860a';
  showToast(shuffleOn ? 'Al√©atoire activ√©' : 'Al√©atoire d√©sactiv√©');
}

function addToQueue(albumIdx) {
  queue.push({ albumIdx });
  renderQueue();
  showToast('Ajout√© √† la file !');
}

function renderQueue() {
  const sec = document.getElementById('queueSection');
  if (!queue.length) { sec.style.display='none'; return; }
  sec.style.display='block';
  document.getElementById('queueList').innerHTML = queue.map((q,i) => 
    `<div class="queue-item">üéµ ${albums[q.albumIdx]?.name||'?'}</div>`
  ).join('');
}

function closeTracks() { document.getElementById('tracksPanel').classList.remove('open'); }

// Load YouTube API
const tag = document.createElement('script');
tag.src = 'https://www.youtube.com/iframe_api';
document.head.appendChild(tag);

loadSaved();
</script>
</body>
</html>
